# Rc\<T\>

**Rc\<T\>** (Reference Counted) à¹ƒà¸«à¹‰à¸«à¸¥à¸²à¸¢ owners à¹„à¸”à¹‰ à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ share ownership

## à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸«à¸£à¹ˆà¹ƒà¸Šà¹‰ Rc?

à¸›à¸à¸•à¸´ Rust à¸¡à¸µ owner à¹€à¸”à¸µà¸¢à¸§ à¹à¸•à¹ˆà¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸¥à¸²à¸¢ owners:

```text
      â”Œâ”€â”€â”€â”€â”€â”
      â”‚  a  â”‚
      â””â”€â”€â”¬â”€â”€â”˜
         â”‚
      â”Œâ”€â”€â–¼â”€â”€â”
      â”‚  5  â”‚â—„â”€â”€ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰ b à¹à¸¥à¸° c à¸”à¹‰à¸§à¸¢
      â””â”€â”€â”€â”€â”€â”˜
         â–²
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
 â”Œâ”€â”€â”´â”€â”€â”   â”Œâ”€â”€â”´â”€â”€â”
 â”‚  b  â”‚   â”‚  c  â”‚
 â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜
```

---

## à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™

```rust
use std::rc::Rc;

fn main() {
    let a = Rc::new(String::from("hello"));

    println!("Count after a: {}", Rc::strong_count(&a)); // 1

    let b = Rc::clone(&a);  // à¹€à¸à¸´à¹ˆà¸¡ reference count
    println!("Count after b: {}", Rc::strong_count(&a)); // 2

    {
        let c = Rc::clone(&a);
        println!("Count in block: {}", Rc::strong_count(&a)); // 3
    } // c dropped, count -= 1

    println!("Count after block: {}", Rc::strong_count(&a)); // 2
}
```

> **à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸:** `Rc::clone` à¹„à¸¡à¹ˆ copy data à¹à¸„à¹ˆà¹€à¸à¸´à¹ˆà¸¡ reference count

---

## Rc::clone vs .clone()

```rust
use std::rc::Rc;

fn main() {
    let a = Rc::new(vec![1, 2, 3]);

    // âœ… Preferred: à¸Šà¸±à¸”à¹€à¸ˆà¸™à¸§à¹ˆà¸²à¹€à¸à¸´à¹ˆà¸¡ reference count
    let b = Rc::clone(&a);

    // âœ… à¸à¹‡à¹ƒà¸Šà¹‰à¹„à¸”à¹‰ à¹à¸•à¹ˆà¸­à¸²à¸ˆà¸ªà¸±à¸šà¸ªà¸™à¸à¸±à¸š deep clone
    let c = a.clone();

    // Both b and c point to the same data
}
```

---

## Shared List Example

```rust
use std::rc::Rc;

enum List {
    Cons(i32, Rc<List>),
    Nil,
}

use List::{Cons, Nil};

fn main() {
    // a = [5, 10, Nil]
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    println!("Count after a: {}", Rc::strong_count(&a)); // 1

    // b = [3, -> a]
    let b = Cons(3, Rc::clone(&a));
    println!("Count after b: {}", Rc::strong_count(&a)); // 2

    // c = [4, -> a]
    let c = Cons(4, Rc::clone(&a));
    println!("Count after c: {}", Rc::strong_count(&a)); // 3

    // a à¸–à¸¹à¸ share à¹‚à¸”à¸¢ b à¹à¸¥à¸° c
}
```

```text
b: Cons(3, â”€â”
           â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â””â”€â”€â”€â”€â–ºâ”‚ a: Cons(5, Cons(10, Nil))â”‚
           â”Œâ”€â”€â”€â”€â–ºâ”‚                         â”‚
           â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
c: Cons(4, â”€â”˜
```

---

## Rc\<T\> Properties

| Property        | Description                 |
| --------------- | --------------------------- |
| Single-threaded | à¹„à¸¡à¹ˆ thread-safe             |
| Immutable       | à¹„à¸”à¹‰à¹à¸„à¹ˆ `&T` à¹„à¸¡à¹ˆà¹„à¸”à¹‰ `&mut T` |
| No Copy         | à¹ƒà¸Šà¹‰ Rc::clone()             |
| Automatic drop  | à¹€à¸¡à¸·à¹ˆà¸­ count à¹€à¸›à¹‡à¸™ 0          |

---

## Rc à¸à¸±à¸š Methods

```rust
use std::rc::Rc;

fn main() {
    let a = Rc::new(String::from("hello"));

    // Deref à¹ƒà¸Šà¹‰ methods à¸‚à¸­à¸‡ inner type à¹„à¸”à¹‰
    println!("Length: {}", a.len());
    println!("Uppercase: {}", a.to_uppercase());

    // Rc methods
    println!("Strong count: {}", Rc::strong_count(&a));

    // Get reference
    let s: &String = &a;
    println!("Ref: {}", s);
}
```

---

## Rc::downgrade à¹à¸¥à¸° Weak

```rust
use std::rc::{Rc, Weak};

fn main() {
    let strong = Rc::new(5);
    let weak: Weak<i32> = Rc::downgrade(&strong);

    println!("Strong count: {}", Rc::strong_count(&strong)); // 1
    println!("Weak count: {}", Rc::weak_count(&strong));     // 1

    // Weak à¸•à¹‰à¸­à¸‡ upgrade à¹€à¸›à¹‡à¸™ Rc à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰
    if let Some(value) = weak.upgrade() {
        println!("Value: {}", value);
    }

    drop(strong); // strong dropped

    // Weak à¸¢à¸±à¸‡ upgrade à¹„à¸¡à¹ˆà¹„à¸”à¹‰
    assert!(weak.upgrade().is_none());
}
```

> **Weak** à¹ƒà¸Šà¹‰à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ reference cycles (à¸”à¸¹à¸šà¸— 04-weak.md)

---

## à¸‚à¹‰à¸­à¸ˆà¸³à¸à¸±à¸”à¸‚à¸­à¸‡ Rc

```rust,compile_fail
use std::rc::Rc;

fn main() {
    let a = Rc::new(5);

    // âŒ Error: cannot borrow as mutable
    // *a += 1;

    // Rc à¹ƒà¸«à¹‰à¹à¸„à¹ˆ shared reference (&T)
    // à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ mutate à¹ƒà¸Šà¹‰à¸£à¹ˆà¸§à¸¡à¸à¸±à¸š RefCell
}
```

---

## Rc + RefCell Pattern

```rust
use std::rc::Rc;
use std::cell::RefCell;

fn main() {
    // Multiple owners + Interior mutability
    let value = Rc::new(RefCell::new(5));

    let a = Rc::clone(&value);
    let b = Rc::clone(&value);

    // à¸—à¸±à¹‰à¸‡ a à¹à¸¥à¸° b à¸ªà¸²à¸¡à¸²à¸£à¸– mutate à¹„à¸”à¹‰
    *a.borrow_mut() += 10;
    *b.borrow_mut() += 10;

    println!("Value: {}", value.borrow()); // 25
}
```text

---

## à¸¥à¸­à¸‡à¸—à¸³à¸”à¸¹! ğŸ¯

1. à¸ªà¸£à¹‰à¸²à¸‡ shared data à¸”à¹‰à¸§à¸¢ Rc
2. Print strong_count à¸‚à¸“à¸° clone à¹à¸¥à¸° drop
3. à¸¥à¸­à¸‡ combine Rc à¸à¸±à¸š RefCell

---

## à¸ªà¸£à¸¸à¸›

| Function                | à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢                |
| ----------------------- | ----------------------- |
| `Rc::new(v)`            | à¸ªà¸£à¹‰à¸²à¸‡ Rc à¹ƒà¸«à¸¡à¹ˆ           |
| `Rc::clone(&rc)`        | à¹€à¸à¸´à¹ˆà¸¡ reference count   |
| `Rc::strong_count(&rc)` | à¸ˆà¸³à¸™à¸§à¸™ strong references |
| `Rc::weak_count(&rc)`   | à¸ˆà¸³à¸™à¸§à¸™ weak references   |
| `Rc::downgrade(&rc)`    | à¸ªà¸£à¹‰à¸²à¸‡ Weak reference    |

### à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸«à¸£à¹ˆà¹ƒà¸Šà¹‰

| Situation                      | Use               |
| ------------------------------ | ----------------- |
| Single owner                   | à¸›à¸à¸•à¸´ (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ Rc) |
| Multiple owners, single-thread | Rc                |
| Multiple owners, multi-thread  | Arc (à¸šà¸—à¸—à¸µà¹ˆ 15)    |
| Mutability needed              | Rc + RefCell      |

ğŸ‘‰ à¸•à¹ˆà¸­à¹„à¸›: [RefCell\<T\>](./03-refcell.md)

```